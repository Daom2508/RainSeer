<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RainSeer Map Activity</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

    <button class="back-btn" onclick="window.location.href='{{ url_for('showcase') }}'">← Volver</button>
    <div id="map"></div>

    <div class="date-container">
        <input type="text" id="fecha" placeholder="MM-DD" maxlength="5">
        <button onclick="seleccionarFecha()">Aceptar</button>
    </div>

    <script>
        var map = L.map('map').setView([20, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var marker = L.marker([51.5, -0.09]).addTo(map)
            .bindPopup('Ejemplo de marcador')
            .openPopup();

        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            marker.setLatLng(e.latlng);

            if (!window.fechaMes || !window.fechaDia) {
                alert("Primero selecciona una fecha");
                return;
            }

            const v1 = window.fechaDia;
            const v2 = window.fechaMes;

            fetch('/get_weather_by_date', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon, v1: v1, v2: v2 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(`Día: ${v1}, Mes: ${v2}\nTemperatura: ${data.temperature} °C\nLluvia: ${data.rain} mm`);
                }
            });
        }

        map.on('click', onMapClick);

        function seleccionarFecha() {
            const input = document.getElementById('fecha').value;
            const regex = /^(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;

            if (!regex.test(input)) {
                alert("Formato inválido. Usa MM-DD");
                return;
            }

            let parts = input.split('-');
            window.fechaMes = parts[0];
            window.fechaDia = parts[1];

            alert(`v1 (día): ${window.fechaDia}\nv2 (mes): ${window.fechaMes}`);
        }
    </script>
</body>
</html>
