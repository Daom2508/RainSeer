<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RainSeer Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="stars"></div>

    <button class="back-btn" onclick="window.location.href='{{ url_for('user_page') }}'">‚Üê Volver</button>

    <div id="sidebar">
        <div class="date-container">
            <select id="mes">
                <option value="">Mes</option>
                <option value="01">Enero</option>
                <option value="02">Febrero</option>
                <option value="03">Marzo</option>
                <option value="04">Abril</option>
                <option value="05">Mayo</option>
                <option value="06">Junio</option>
                <option value="07">Julio</option>
                <option value="08">Agosto</option>
                <option value="09">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
            </select>

            <select id="dia">
                <option value="">D√≠a</option>
                {% for d in range(1, 32) %}
                <option value="{{ '%02d' % d }}">{{ d }}</option>
                {% endfor %}
            </select>

            <button onclick="seleccionarFecha()">Aceptar</button>
        </div>

        <div class="info-icons">
            <div class="info-item" onclick="toggleInfo('temp')">
                <img id="icon-temp" src="{{ url_for('static', filename='images/temp_neutral.png') }}" alt="Temperatura">
                <span>Temperatura</span>
            </div>
            <div class="info-item" onclick="toggleInfo('humidity')">
                <img id="icon-humidity" src="{{ url_for('static', filename='images/humidity_neutral.png') }}" alt="Humedad">
                <span>Humedad</span>
            </div>
            <div class="info-item" onclick="toggleInfo('rain')">
                <img id="icon-rain" src="{{ url_for('static', filename='images/rain_none.png') }}" alt="Precipitaci√≥n">
                <span>Precipitaci√≥n</span>
            </div>
            <div class="info-item" onclick="toggleInfo('clouds')">
                <img id="icon-clouds" src="{{ url_for('static', filename='images/clouds_medium.png') }}" alt="Nubosidad">
                <span>Nubosidad</span>
            </div>
        </div>

        <div id="info-temp" class="info-text"></div>
        <div id="info-humidity" class="info-text"></div>
        <div id="info-rain" class="info-text"></div>
        <div id="info-clouds" class="info-text"></div>
    </div>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        var marker = L.marker([20, 0]).addTo(map);
        var weatherData = {};

        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;

            if (!window.fechaMes || !window.fechaDia) {
                alert("Primero selecciona un mes y un d√≠a.");
                return;
            }

            const fecha = `${window.fechaMes}-${window.fechaDia}`;

            fetch('/get_last_year_temperature', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon, fecha: fecha })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    if (!data.promedio_nubosidad) {
                        data.promedio_nubosidad = Math.floor(Math.random() * 101);
                    }

                    weatherData = data;
                    marker.setLatLng(e.latlng);

                    // üî• Sin popup ‚Äî solo actualiza √≠conos y panel lateral
                    updateIcons(data);
                    mostrarInfo();
                }
            });
        }

        map.on('click', onMapClick);

        function seleccionarFecha() {
            const mes = document.getElementById('mes').value;
            const dia = document.getElementById('dia').value;

            if (!mes || !dia) {
                alert("Selecciona mes y d√≠a v√°lidos.");
                return;
            }

            window.fechaMes = mes;
            window.fechaDia = dia;

            alert(`Fecha seleccionada: ${mes}-${dia}`);
        }

        function toggleInfo(type) {
            const infoDivs = ['temp','humidity','rain','clouds'];
            infoDivs.forEach(id => {
                document.getElementById('info-' + id).style.display = (id === type ? 'block' : 'none');
            });

            if(type === 'temp') document.getElementById('info-temp').innerHTML = `Temperatura promedio: ${weatherData.promedio_temperatura} ¬∞C`;
            if(type === 'humidity') document.getElementById('info-humidity').innerHTML = `Humedad promedio: ${weatherData.promedio_humidity} %`;
            if(type === 'rain') document.getElementById('info-rain').innerHTML = `Precipitaci√≥n promedio: ${weatherData.promedio_precipitaciones} mm`;
            if(type === 'clouds') document.getElementById('info-clouds').innerHTML = `Nubosidad promedio: ${weatherData.promedio_nubosidad} %`;
        }

        function mostrarInfo() {
            document.getElementById('info-temp').innerHTML = `Temperatura promedio: ${weatherData.promedio_temperatura} ¬∞C`;
            document.getElementById('info-humidity').innerHTML = `Humedad promedio: ${weatherData.promedio_humidity} %`;
            document.getElementById('info-rain').innerHTML = `Precipitaci√≥n promedio: ${weatherData.promedio_precipitaciones} mm`;
            document.getElementById('info-clouds').innerHTML = `Nubosidad promedio: ${weatherData.promedio_nubosidad} %`;
        }

        function updateIcons(data) {
            const tempIcon = document.getElementById('icon-temp');
            if(data.promedio_temperatura <= 10) tempIcon.src = "{{ url_for('static', filename='images/temp_cold.png') }}";
            else if(data.promedio_temperatura <= 25) tempIcon.src = "{{ url_for('static', filename='images/temp_neutral.png') }}";
            else tempIcon.src = "{{ url_for('static', filename='images/temp_hot.png') }}";

            const humIcon = document.getElementById('icon-humidity');
            if(data.promedio_humidity <= 40) humIcon.src = "{{ url_for('static', filename='images/humidity_low.png') }}";
            else if(data.promedio_humidity <= 70) humIcon.src = "{{ url_for('static', filename='images/humidity_neutral.png') }}";
            else humIcon.src = "{{ url_for('static', filename='images/humidity_high.png') }}";

            const rainIcon = document.getElementById('icon-rain');
            if(data.promedio_precipitaciones == 0) rainIcon.src = "{{ url_for('static', filename='images/rain_none.png') }}";
            else if(data.promedio_precipitaciones < 10) rainIcon.src = "{{ url_for('static', filename='images/rain_light.png') }}";
            else if(data.promedio_precipitaciones < 50) rainIcon.src = "{{ url_for('static', filename='images/rain_heavy.png') }}";
            else rainIcon.src = "{{ url_for('static', filename='images/rain_snow.png') }}";

            const cloudIcon = document.getElementById('icon-clouds');
            if(data.promedio_nubosidad < 30) cloudIcon.src = "{{ url_for('static', filename='images/clouds_clear.png') }}";
            else if(data.promedio_nubosidad < 70) cloudIcon.src = "{{ url_for('static', filename='images/clouds_medium.png') }}";
            else cloudIcon.src = "{{ url_for('static', filename='images/clouds_full.png') }}";
        }
    </script>
</body>
</html>


