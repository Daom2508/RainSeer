<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RainSeer Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        #sidebar {
            position: absolute;
            top: 60px;
            left: 20px;
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 12px;
            z-index: 1001;
            color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        #sidebar label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #sidebar input {
            width: 90px;
            padding: 6px;
            margin: 5px;
            border-radius: 6px;
            border: none;
            text-align: center;
            background: rgba(255,255,255,0.1);
            color: white;
        }

        #sidebar button {
            width: 100%;
            padding: 8px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        #sidebar button:hover {
            background: #004999;
        }

        .info-icons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px;
            border-radius: 6px;
            transition: background 0.3s;
        }

        .info-item:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .info-item img {
            width: 38px;
            height: 38px;
            margin-right: 10px;
        }

        .info-text {
            display: none;
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1002;
            padding: 8px 12px;
            border-radius: 8px;
            background: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .back-btn:hover {
            background: #004999;
        }
    </style>
</head>
<body class="star-background">
    <div class="stars"></div>

    <button class="back-btn" onclick="window.location.href='{{ url_for('user_page') }}'">← Volver</button>

    <div id="sidebar">
        <label for="monthInput">Mes:</label>
        <input type="number" id="monthInput" min="1" max="12" placeholder="MM">

        <label for="dayInput">Día:</label>
        <input type="number" id="dayInput" min="1" max="31" placeholder="DD">

        <button onclick="seleccionarFecha()">Aceptar</button>

        <div class="info-icons">
            <div class="info-item" onclick="toggleInfo('temp')">
                <img id="icon-temp" src="{{ url_for('static', filename='images/temp_neutral.png') }}" alt="Temperatura">
                <span>Temperatura</span>
            </div>
            <div class="info-item" onclick="toggleInfo('humidity')">
                <img id="icon-humidity" src="{{ url_for('static', filename='images/humidity_neutral.png') }}" alt="Humedad">
                <span>Humedad</span>
            </div>
            <div class="info-item" onclick="toggleInfo('rain')">
                <img id="icon-rain" src="{{ url_for('static', filename='images/rain_neutral.png') }}" alt="Precipitación">
                <span>Precipitación</span>
            </div>
            <div class="info-item" onclick="toggleInfo('clouds')">
                <img id="icon-clouds" src="{{ url_for('static', filename='images/clouds_medium.png') }}" alt="Nubosidad">
                <span>Nubosidad</span>
            </div>
        </div>

        <div id="info-temp" class="info-text"></div>
        <div id="info-humidity" class="info-text"></div>
        <div id="info-rain" class="info-text"></div>
        <div id="info-clouds" class="info-text"></div>
    </div>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var marker = L.marker([20, 0]).addTo(map);
        var weatherData = {};

        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;

            if (!window.fechaMes || !window.fechaDia) {
                alert("Primero selecciona mes y día.");
                return;
            }

            const fecha = `${window.fechaMes}-${window.fechaDia}`;

            fetch('/get_last_year_temperature', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon, fecha: fecha })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    if (!data.promedio_nubosidad)
                        data.promedio_nubosidad = Math.floor(Math.random() * 101);

                    weatherData = data;
                    marker.setLatLng(e.latlng);
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(
                            `<b>Fecha:</b> ${fecha}<br>
                             <b>Temperatura:</b> ${data.promedio_temperatura} °C<br>
                             <b>Precipitación:</b> ${data.promedio_precipitaciones} mm<br>
                             <b>Humedad:</b> ${data.promedio_humidity}%<br>
                             <b>Nubosidad:</b> ${data.promedio_nubosidad}%`
                        )
                        .openOn(map);
                    updateIcons(data);
                }
            });
        }

        map.on('click', onMapClick);

        function seleccionarFecha() {
            const month = document.getElementById('monthInput').value.padStart(2, '0');
            const day = document.getElementById('dayInput').value.padStart(2, '0');

            if (!month || !day) {
                alert("Por favor ingresa mes y día.");
                return;
            }

            window.fechaMes = month;
            window.fechaDia = day;

            alert(`Fecha seleccionada: ${month}-${day}`);
        }

        function toggleInfo(type) {
            const infoDivs = ['temp','humidity','rain','clouds'];
            infoDivs.forEach(id => {
                document.getElementById('info-' + id).style.display = (id === type ? 'block' : 'none');
            });

            if(type === 'temp') document.getElementById('info-temp').innerHTML = `Temperatura promedio: ${weatherData.promedio_temperatura} °C`;
            if(type === 'humidity') document.getElementById('info-humidity').innerHTML = `Humedad promedio: ${weatherData.promedio_humidity} %`;
            if(type === 'rain') document.getElementById('info-rain').innerHTML = `Precipitación promedio: ${weatherData.promedio_precipitaciones} mm`;
            if(type === 'clouds') document.getElementById('info-clouds').innerHTML = `Nubosidad promedio: ${weatherData.promedio_nubosidad} %`;
        }

        function updateIcons(data) {
            const tempIcon = document.getElementById('icon-temp');
            if(data.promedio_temperatura <= 10) tempIcon.src = "{{ url_for('static', filename='images/temp_cold.png') }}";
            else if(data.promedio_temperatura <= 25) tempIcon.src = "{{ url_for('static', filename='images/temp_neutral.png') }}";
            else tempIcon.src = "{{ url_for('static', filename='images/temp_hot.png') }}";

            const humIcon = document.getElementById('icon-humidity');
            if(data.promedio_humidity <= 40) humIcon.src = "{{ url_for('static', filename='images/humidity_low.png') }}";
            else if(data.promedio_humidity <= 70) humIcon.src = "{{ url_for('static', filename='images/humidity_neutral.png') }}";
            else humIcon.src = "{{ url_for('static', filename='images/humidity_high.png') }}";

            const rainIcon = document.getElementById('icon-rain');
            if(data.promedio_precipitaciones == 0) rainIcon.src = "{{ url_for('static', filename='images/rain_none.png') }}";
            else if(data.promedio_precipitaciones < 10) rainIcon.src = "{{ url_for('static', filename='images/rain_light.png') }}";
            else if(data.promedio_precipitaciones < 50) rainIcon.src = "{{ url_for('static', filename='images/rain_heavy.png') }}";
            else rainIcon.src = "{{ url_for('static', filename='images/rain_snow.png') }}";

            const cloudIcon = document.getElementById('icon-clouds');
            if(data.promedio_nubosidad < 30) cloudIcon.src = "{{ url_for('static', filename='images/clouds_clear.png') }}";
            else if(data.promedio_nubosidad < 70) cloudIcon.src = "{{ url_for('static', filename='images/clouds_medium.png') }}";
            else cloudIcon.src = "{{ url_for('static', filename='images/clouds_full.png') }}";
        }
    </script>
</body>
</html>
